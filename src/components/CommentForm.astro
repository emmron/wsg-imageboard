---
// CommentForm component for adding comments to videos
---

<div class="comment-form" data-video-id="">
  <div class="validation-errors" id="comment-validation-errors" style="display: none;"></div>
  <div class="validation-warnings" id="comment-validation-warnings" style="display: none;"></div>
  
  <textarea
    id="comment-text"
    placeholder="Add a comment... (Press Enter to post, Shift+Enter for new line)"
    class="comment-textarea"
  ></textarea>
  
  <div class="form-actions">
    <small>Anonymous comment - Hash ID will be generated</small>
    <div class="form-meta">
      <span class="char-count" id="char-count">0/1000</span>
    </div>
    <button 
      type="button"
      id="post-comment-btn"
      class="post-comment-btn"
      disabled
    >
      Post Comment
    </button>
  </div>
</div>

<script>
  import { addComment, videos } from '../lib/stores.ts';
  import { generateHash, generateAnonymousHash } from '../lib/utils.ts';
  import { validateComment, sanitizeText } from '../lib/validation.ts';

  class CommentForm {
    private form: HTMLElement;
    private textarea: HTMLTextAreaElement;
    private postBtn: HTMLButtonElement;
    private charCount: HTMLElement;
    private validationErrors: HTMLElement;
    private validationWarnings: HTMLElement;
    private posting = false;

    constructor(formElement: HTMLElement) {
      this.form = formElement;
      this.initializeElements();
      this.setupEventListeners();
    }

    private initializeElements() {
      this.textarea = this.form.querySelector('#comment-text') as HTMLTextAreaElement;
      this.postBtn = this.form.querySelector('#post-comment-btn') as HTMLButtonElement;
      this.charCount = this.form.querySelector('#char-count') as HTMLElement;
      this.validationErrors = this.form.querySelector('#comment-validation-errors') as HTMLElement;
      this.validationWarnings = this.form.querySelector('#comment-validation-warnings') as HTMLElement;
    }

    private setupEventListeners() {
      this.textarea.addEventListener('input', this.handleInput.bind(this));
      this.textarea.addEventListener('keypress', this.handleKeyPress.bind(this));
      this.postBtn.addEventListener('click', this.postComment.bind(this));
    }

    private handleInput() {
      const text = this.textarea.value;
      this.updateCharCount(text.length);
      this.validateCommentInput(text);
    }

    private handleKeyPress(event: KeyboardEvent) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        this.postComment();
      }
    }

    private updateCharCount(length: number) {
      this.charCount.textContent = `${length}/1000`;
      this.charCount.classList.toggle('warning', length > 800);
    }

    private validateCommentInput(text: string) {
      if (!text.trim()) {
        this.hideValidation();
        this.postBtn.disabled = true;
        return;
      }

      const validation = validateComment(text);
      this.showValidationErrors(validation.errors);
      this.showValidationWarnings(validation.warnings);

      this.postBtn.disabled = !validation.valid || this.posting;
    }

    private showValidationErrors(errors: string[]) {
      if (errors.length > 0) {
        this.validationErrors.innerHTML = errors
          .map(error => `<div class="error-message">âš  ${error}</div>`)
          .join('');
        this.validationErrors.style.display = 'block';
        this.textarea.classList.add('error');
      } else {
        this.validationErrors.style.display = 'none';
        this.textarea.classList.remove('error');
      }
    }

    private showValidationWarnings(warnings: string[]) {
      if (warnings.length > 0) {
        this.validationWarnings.innerHTML = warnings
          .map(warning => `<div class="warning-message">âš  ${warning}</div>`)
          .join('');
        this.validationWarnings.style.display = 'block';
      } else {
        this.validationWarnings.style.display = 'none';
      }
    }

    private hideValidation() {
      this.validationErrors.style.display = 'none';
      this.validationWarnings.style.display = 'none';
      this.textarea.classList.remove('error');
    }

    private async postComment() {
      const text = this.textarea.value.trim();
      if (!text) return;

      const videoId = this.form.dataset.videoId;
      if (!videoId) return;

      const validation = validateComment(text);
      if (!validation.valid) {
        this.showValidationErrors(validation.errors);
        return;
      }

      this.posting = true;
      this.postBtn.disabled = true;
      this.postBtn.textContent = 'Posting...';

      try {
        const newComment = {
          id: generateHash(text + Date.now()),
          userHash: generateAnonymousHash(),
          text: sanitizeText(text),
          timestamp: Date.now()
        };

        // Update the videos store
        const currentVideos = videos.get();
        const updatedVideos = currentVideos.map(video => {
          if (video.id === videoId) {
            return {
              ...video,
              comments: [...video.comments, newComment]
            };
          }
          return video;
        });
        videos.set(updatedVideos);

        // Reset form
        this.resetForm();

        // Refresh the modal if it's showing this video
        this.refreshModalComments(videoId, newComment);

      } catch (error) {
        console.error('Failed to post comment:', error);
        this.posting = false;
        this.postBtn.disabled = false;
        this.postBtn.textContent = 'Post Comment';
      }
    }

    private refreshModalComments(videoId: string, newComment: any) {
      // Update comments in the modal
      const commentsCount = document.getElementById('comments-count');
      const commentsHeader = document.getElementById('comments-header');
      const noComments = document.getElementById('no-comments');
      const commentsList = document.getElementById('comments-list');

      if (commentsCount && commentsHeader && commentsList) {
        // Get updated video data
        const currentVideos = videos.get();
        const video = currentVideos.find(v => v.id === videoId);
        
        if (video) {
          const count = video.comments.length;
          commentsCount.textContent = `ðŸ’¬ ${count}`;
          commentsHeader.textContent = `Comments (${count})`;

          if (noComments) {
            noComments.style.display = 'none';
          }
          
          commentsList.style.display = 'block';
          
          // Add new comment to the list
          const commentElement = document.createElement('div');
          commentElement.className = 'comment';
          commentElement.innerHTML = `
            <div class="comment-header">
              <span class="comment-hash">#${newComment.hash}</span>
              <span class="comment-date">${this.formatDate(new Date(newComment.timestamp))}</span>
            </div>
            <p class="comment-text">${newComment.text}</p>
          `;
          commentsList.appendChild(commentElement);
        }
      }
    }

    private resetForm() {
      this.textarea.value = '';
      this.updateCharCount(0);
      this.hideValidation();
      this.posting = false;
      this.postBtn.disabled = true;
      this.postBtn.textContent = 'Post Comment';
    }

    private formatDate(date: Date): string {
      const now = new Date();
      const diff = now.getTime() - date.getTime();
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      
      if (minutes < 1) return 'Just now';
      if (minutes < 60) return `${minutes}m ago`;
      if (hours < 24) return `${hours}h ago`;
      if (days < 7) return `${days}d ago`;
      return date.toLocaleDateString();
    }

    public setVideoId(videoId: string) {
      this.form.dataset.videoId = videoId;
    }
  }

  // Initialize comment forms
  document.addEventListener('DOMContentLoaded', () => {
    const commentForms = document.querySelectorAll('.comment-form');
    commentForms.forEach(form => {
      new CommentForm(form as HTMLElement);
    });
  });

  // Handle video changes to update the form's video ID
  import { selectedVideo } from '../lib/stores.ts';
  
  selectedVideo.subscribe((video) => {
    const commentForm = document.querySelector('.comment-form') as HTMLElement;
    if (commentForm && video) {
      commentForm.dataset.videoId = video.id;
    }
  });
</script>

<style>
  .comment-form {
    background: rgba(64, 64, 64, 0.8);
    border-radius: 12px;
    padding: clamp(0.875rem, 3vw, 1rem);
    margin-top: clamp(0.875rem, 3vw, 1rem);
    border: 1px solid rgba(85, 85, 85, 0.6);
    backdrop-filter: blur(16px) saturate(150%);
    position: relative;
    transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    will-change: transform, box-shadow;
  }

  .comment-form::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(
      90deg,
      transparent,
      rgba(74, 222, 128, 0.3),
      transparent
    );
    border-radius: 12px 12px 0 0;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .comment-form:focus-within {
    border-color: rgba(74, 222, 128, 0.5);
    background: rgba(74, 222, 128, 0.05);
    transform: translateY(-1px);
    box-shadow: 
      0 1px 0 rgba(255, 255, 255, 0.05) inset,
      0 8px 32px rgba(74, 222, 128, 0.1),
      0 4px 16px rgba(0, 0, 0, 0.1);
  }

  .comment-form:focus-within::before {
    opacity: 1;
  }

  .comment-textarea {
    width: 100%;
    min-height: clamp(80px, 15vw, 100px);
    max-height: 200px;
    background: rgba(45, 45, 45, 0.8);
    border: 1px solid rgba(85, 85, 85, 0.8);
    color: #fff;
    padding: clamp(0.7rem, 2vw, 0.8rem);
    border-radius: 8px;
    resize: vertical;
    font-family: inherit;
    font-size: clamp(0.85rem, 2.5vw, 0.9rem);
    line-height: 1.5;
    outline: none;
    transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    backdrop-filter: blur(10px) saturate(150%);
    will-change: transform, border-color, box-shadow;
  }

  .comment-textarea::placeholder {
    color: rgba(255, 255, 255, 0.5);
    transition: color 0.2s ease;
  }

  .comment-textarea:focus {
    border-color: #4ade80;
    background: rgba(74, 222, 128, 0.08);
    box-shadow: 
      0 0 0 2px rgba(74, 222, 128, 0.2),
      0 4px 16px rgba(74, 222, 128, 0.1);
    transform: translateY(-1px) scale(1.002);
  }

  .comment-textarea:focus::placeholder {
    color: rgba(255, 255, 255, 0.7);
  }

  .comment-textarea:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background: rgba(45, 45, 45, 0.4);
  }

  .comment-textarea.error {
    border-color: #dc2626;
    background: rgba(220, 38, 38, 0.08);
    box-shadow: 
      0 0 0 2px rgba(220, 38, 38, 0.2),
      0 4px 16px rgba(220, 38, 38, 0.1);
  }

  @media (hover: hover) {
    .comment-textarea:hover:not(:focus):not(:disabled) {
      border-color: rgba(128, 128, 128, 0.9);
      background: rgba(45, 45, 45, 0.9);
      transform: translateY(-0.5px);
    }
  }

  .validation-errors {
    background: rgba(220, 38, 38, 0.1);
    border: 1px solid rgba(220, 38, 38, 0.5);
    border-radius: 8px;
    padding: clamp(0.4rem, 1.5vw, 0.5rem) clamp(0.6rem, 2vw, 0.75rem);
    margin-bottom: clamp(0.4rem, 1.5vw, 0.5rem);
    backdrop-filter: blur(10px) saturate(150%);
    position: relative;
    overflow: hidden;
    animation: errorPulse 0.4s ease-out;
  }

  @keyframes errorPulse {
    0% { 
      transform: scale(1);
      box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4);
    }
    50% { 
      transform: scale(1.02);
      box-shadow: 0 0 0 4px rgba(220, 38, 38, 0.2);
    }
    100% { 
      transform: scale(1);
      box-shadow: 0 0 0 0 rgba(220, 38, 38, 0);
    }
  }

  .validation-warnings {
    background: rgba(245, 158, 11, 0.1);
    border: 1px solid rgba(245, 158, 11, 0.5);
    border-radius: 8px;
    padding: clamp(0.4rem, 1.5vw, 0.5rem) clamp(0.6rem, 2vw, 0.75rem);
    margin-bottom: clamp(0.4rem, 1.5vw, 0.5rem);
    backdrop-filter: blur(10px) saturate(150%);
    position: relative;
    overflow: hidden;
    animation: warningFade 0.3s ease-out;
  }

  @keyframes warningFade {
    0% { 
      opacity: 0;
      transform: translateY(-10px);
    }
    100% { 
      opacity: 1;
      transform: translateY(0);
    }
  }

  .error-message {
    color: #fca5a5;
    font-size: 0.8rem;
    margin-bottom: 0.2rem;
  }

  .warning-message {
    color: #fbbf24;
    font-size: 0.8rem;
    margin-bottom: 0.2rem;
  }

  .form-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 0.8rem;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .form-actions small {
    color: #999;
    font-size: 0.8rem;
  }

  .form-meta {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .char-count {
    color: #999;
    font-size: 0.8rem;
    font-family: monospace;
    transition: color 0.2s ease;
  }

  .char-count.warning {
    color: #f59e0b;
  }

  .post-comment-btn {
    background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
    color: #000;
    border: 1px solid rgba(255, 255, 255, 0.1);
    padding: clamp(0.4rem, 1.5vw, 0.5rem) clamp(0.75rem, 2vw, 1rem);
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: clamp(0.8rem, 2vw, 0.9rem);
    transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    position: relative;
    overflow: hidden;
    backdrop-filter: blur(10px) saturate(150%);
    box-shadow: 
      0 2px 8px rgba(74, 222, 128, 0.3),
      0 1px 2px rgba(74, 222, 128, 0.2) inset;
    will-change: transform, box-shadow;
  }

  .post-comment-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
      90deg,
      transparent,
      rgba(255, 255, 255, 0.3),
      transparent
    );
    transition: left 0.4s ease;
  }

  .post-comment-btn:hover:not(:disabled) {
    background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    transform: translateY(-1px) scale(1.02);
    box-shadow: 
      0 4px 16px rgba(74, 222, 128, 0.4),
      0 2px 8px rgba(0, 0, 0, 0.2),
      0 2px 4px rgba(74, 222, 128, 0.3) inset;
  }

  .post-comment-btn:hover:not(:disabled)::before {
    left: 100%;
  }

  .post-comment-btn:active:not(:disabled) {
    transform: translateY(0) scale(1);
    transition-duration: 0.1s;
  }

  .post-comment-btn:disabled {
    background: rgba(85, 85, 85, 0.6);
    color: rgba(153, 153, 153, 0.8);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
    border-color: rgba(85, 85, 85, 0.4);
  }

  .post-comment-btn:focus-visible:not(:disabled) {
    outline: 2px solid #4ade80;
    outline-offset: 2px;
  }

  @media (max-width: 768px) {
    .comment-form {
      padding: clamp(0.75rem, 3vw, 0.875rem);
      border-radius: 10px;
    }

    .comment-textarea {
      min-height: clamp(70px, 12vw, 80px);
      font-size: clamp(0.8rem, 3vw, 0.85rem);
      padding: clamp(0.6rem, 2vw, 0.7rem);
    }

    .form-actions {
      flex-direction: column;
      align-items: stretch;
      gap: clamp(0.5rem, 2vw, 0.75rem);
    }

    .form-meta {
      justify-content: space-between;
      order: 1;
    }

    .post-comment-btn {
      order: 2;
      padding: clamp(0.6rem, 2vw, 0.75rem);
      font-size: clamp(0.85rem, 3vw, 0.9rem);
    }

    .validation-errors,
    .validation-warnings {
      padding: clamp(0.5rem, 2vw, 0.6rem);
      margin-bottom: clamp(0.5rem, 2vw, 0.6rem);
    }

    .error-message,
    .warning-message {
      font-size: clamp(0.75rem, 2.5vw, 0.8rem);
    }
  }

  @media (max-width: 480px) {
    .comment-form {
      padding: 0.75rem;
      border-radius: 8px;
    }

    .comment-textarea {
      min-height: 70px;
      font-size: 0.8rem;
      padding: 0.6rem;
    }

    .form-actions small {
      font-size: 0.75rem;
    }

    .char-count {
      font-size: 0.75rem;
    }

    .post-comment-btn {
      padding: 0.6rem 1rem;
      font-size: 0.85rem;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .comment-form,
    .comment-form::before,
    .comment-textarea,
    .post-comment-btn,
    .post-comment-btn::before,
    .validation-errors,
    .validation-warnings {
      animation: none !important;
      transition: none !important;
    }

    .comment-form:focus-within {
      transform: none !important;
    }

    .comment-textarea:focus,
    .comment-textarea:hover {
      transform: none !important;
    }

    .post-comment-btn:hover:not(:disabled),
    .post-comment-btn:active:not(:disabled) {
      transform: none !important;
    }
  }
</style>