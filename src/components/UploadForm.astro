---
// Clean Vimeo-style upload form
---

<div class="upload-form">
  <div class="file-drop" id="file-drop">
    <div class="file-selected" id="file-selected" style="display: none;">
      <div class="file-info">
        <span class="file-name" id="file-name">‚úì Selected file</span>
        <span class="file-details" id="file-details"></span>
      </div>
      <button type="button" class="remove-btn" id="remove-file">Remove</button>
    </div>
    
    <div class="drop-zone" id="drop-zone">
      <div class="drop-content">
        <div class="drop-icon">üìÅ</div>
        <p>Drop video file here or click to select</p>
        <small>Supports all major video formats (MP4, AVI, MOV, WMV, FLV, WebM, MKV, etc.) ‚Ä¢ Max 2GB</small>
      </div>
      <input 
        type="file" 
        accept="video/*" 
        style="display: none;"
        id="file-input"
      />
    </div>
  </div>
  
  <div class="form-group">
    <label for="title">Title *</label>
    <input 
      type="text" 
      id="title"
      placeholder="Enter video title..."
      required
    />
  </div>
  
  <div class="form-group">
    <label for="tags">Tags (optional)</label>
    <input 
      type="text" 
      id="tags"
      placeholder="Add tags separated by commas..."
    />
  </div>
  
  <div class="upload-progress" id="upload-progress" style="display: none;">
    <div class="progress-bar">
      <div class="progress-fill" id="progress-fill"></div>
    </div>
    <p id="progress-text">Uploading... 0%</p>
  </div>
  
  <div class="success-message" id="success-message" style="display: none;">
    ‚úì Video uploaded successfully!
  </div>
  
  <button 
    type="button"
    class="upload-btn"
    id="upload-btn"
    disabled
  >
    Upload Video
  </button>
</div>

<script>
  import { addVideo } from '../lib/stores.ts';
  import { generateHash, generateAnonymousHash } from '../lib/utils.ts';

  class UploadForm {
    private form: HTMLElement;
    private fileDrop: HTMLElement;
    private fileInput: HTMLInputElement;
    private fileSelected: HTMLElement;
    private dropZone: HTMLElement;
    private titleInput: HTMLInputElement;
    private tagsInput: HTMLInputElement;
    private uploadBtn: HTMLButtonElement;
    private removeBtn: HTMLButtonElement;
    private uploadProgress: HTMLElement;
    private progressFill: HTMLElement;
    private progressText: HTMLElement;
    private successMessage: HTMLElement;
    private fileName: HTMLElement;
    private fileDetails: HTMLElement;

    private selectedFile: File | null = null;
    private dragCounter = 0;
    private uploading = false;

    constructor(formElement: HTMLElement) {
      this.form = formElement;
      this.initializeElements();
      this.setupEventListeners();
    }

    private initializeElements() {
      this.fileDrop = this.form.querySelector('#file-drop') as HTMLElement;
      this.fileInput = this.form.querySelector('#file-input') as HTMLInputElement;
      this.fileSelected = this.form.querySelector('#file-selected') as HTMLElement;
      this.dropZone = this.form.querySelector('#drop-zone') as HTMLElement;
      this.titleInput = this.form.querySelector('#title') as HTMLInputElement;
      this.tagsInput = this.form.querySelector('#tags') as HTMLInputElement;
      this.uploadBtn = this.form.querySelector('#upload-btn') as HTMLButtonElement;
      this.removeBtn = this.form.querySelector('#remove-file') as HTMLButtonElement;
      this.uploadProgress = this.form.querySelector('#upload-progress') as HTMLElement;
      this.progressFill = this.form.querySelector('#progress-fill') as HTMLElement;
      this.progressText = this.form.querySelector('#progress-text') as HTMLElement;
      this.successMessage = this.form.querySelector('#success-message') as HTMLElement;
      this.fileName = this.form.querySelector('#file-name') as HTMLElement;
      this.fileDetails = this.form.querySelector('#file-details') as HTMLElement;
    }

    private setupEventListeners() {
      // File selection
      this.fileInput.addEventListener('change', this.handleFileSelect.bind(this));
      this.dropZone.addEventListener('click', () => this.fileInput.click());
      this.removeBtn.addEventListener('click', this.removeFile.bind(this));

      // Drag and drop
      this.fileDrop.addEventListener('dragenter', this.handleDragEnter.bind(this));
      this.fileDrop.addEventListener('dragover', this.handleDragOver.bind(this));
      this.fileDrop.addEventListener('dragleave', this.handleDragLeave.bind(this));
      this.fileDrop.addEventListener('drop', this.handleDrop.bind(this));

      // Form validation
      this.titleInput.addEventListener('input', this.validateForm.bind(this));
      this.tagsInput.addEventListener('input', this.validateForm.bind(this));

      // Upload
      this.uploadBtn.addEventListener('click', this.uploadVideo.bind(this));
    }

    private handleFileSelect(event: Event) {
      const target = event.target as HTMLInputElement;
      const file = target.files?.[0];
      if (file) {
        this.processFile(file);
      }
    }

    private handleDragEnter(event: DragEvent) {
      event.preventDefault();
      this.dragCounter++;
      this.fileDrop.classList.add('drag-over');
    }

    private handleDragOver(event: DragEvent) {
      event.preventDefault();
    }

    private handleDragLeave(event: DragEvent) {
      event.preventDefault();
      this.dragCounter--;
      if (this.dragCounter === 0) {
        this.fileDrop.classList.remove('drag-over');
      }
    }

    private handleDrop(event: DragEvent) {
      event.preventDefault();
      this.dragCounter = 0;
      this.fileDrop.classList.remove('drag-over');
      
      const file = event.dataTransfer?.files[0];
      if (file && file.type.startsWith('video/')) {
        this.processFile(file);
      }
    }

    private processFile(file: File) {
      if (!file.type.startsWith('video/')) {
        alert('Please select a video file.');
        return;
      }

      if (file.size > 2 * 1024 * 1024 * 1024) { // 2GB limit
        alert('File size must be less than 2GB.');
        return;
      }

      this.selectedFile = file;
      this.showFileSelected(file);
      this.validateForm();
    }

    private showFileSelected(file: File) {
      this.dropZone.style.display = 'none';
      this.fileSelected.style.display = 'flex';

      this.fileName.textContent = `‚úì ${file.name}`;
      this.fileDetails.textContent = `${this.formatFileSize(file.size)} ‚Ä¢ ${file.type}`;
    }

    private removeFile() {
      this.selectedFile = null;
      this.fileSelected.style.display = 'none';
      this.dropZone.style.display = 'block';
      this.fileInput.value = '';
      this.validateForm();
    }

    private validateForm() {
      const canUpload = this.selectedFile && 
                       this.titleInput.value.trim() && 
                       !this.uploading;
      
      this.uploadBtn.disabled = !canUpload;
    }

    private async uploadVideo() {
      if (!this.selectedFile || !this.titleInput.value.trim()) return;

      this.uploading = true;
      this.uploadBtn.disabled = true;
      this.uploadBtn.textContent = 'Uploading...';
      this.uploadProgress.style.display = 'block';

      try {
        // Parse tags
        const tags = this.tagsInput.value
          .split(',')
          .map(tag => tag.trim())
          .filter(tag => tag.length > 0);

        // Prepare form data for API upload
        const formData = new FormData();
        formData.append('video', this.selectedFile);
        formData.append('title', this.titleInput.value.trim());
        formData.append('tags', tags.join(','));

        // Update progress
        this.progressFill.style.width = '30%';
        this.progressText.textContent = 'Uploading to server...';

        // Upload to API
        const uploadResponse = await fetch('/api/video/upload', {
          method: 'POST',
          body: formData
        });

        if (!uploadResponse.ok) {
          throw new Error('Upload failed');
        }

        const uploadResult = await uploadResponse.json();
        
        if (!uploadResult.success) {
          throw new Error(uploadResult.message || 'Upload failed');
        }

        this.progressFill.style.width = '60%';
        this.progressText.textContent = 'Processing video...';

        // Check if video needs conversion
        if (uploadResult.needsConversion) {
          await this.handleVideoConversion(uploadResult.videoId);
        } else {
          // Video is web-compatible, create video object directly
          await this.createVideoObject(uploadResult.videoId);
        }

        this.progressFill.style.width = '100%';
        this.progressText.textContent = 'Upload complete!';

        // Show success and reset form
        this.showSuccess();
        this.resetForm();

        // Dispatch upload complete event
        window.dispatchEvent(new CustomEvent('upload-complete'));

      } catch (error) {
        console.error('Upload failed:', error);
        alert(`Upload failed: ${error.message}`);
        this.uploading = false;
        this.uploadBtn.disabled = false;
        this.uploadBtn.textContent = 'Upload Video';
        this.uploadProgress.style.display = 'none';
      }
    }

    private async handleVideoConversion(videoId: string) {
      // Start conversion process
      const processResponse = await fetch('/api/video/process', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          videoId,
          originalFormat: this.selectedFile.type,
          targetFormat: 'video/mp4'
        })
      });

      if (!processResponse.ok) {
        throw new Error('Video processing failed');
      }

      // Poll for conversion status
      await this.pollConversionStatus(videoId);
    }

    private async pollConversionStatus(videoId: string): Promise<void> {
      return new Promise(async (resolve, reject) => {
        const maxAttempts = 30; // 30 seconds max
        let attempts = 0;

        const poll = async () => {
          try {
            const statusResponse = await fetch(`/api/video/process?videoId=${videoId}`);
            
            if (!statusResponse.ok) {
              throw new Error('Failed to check conversion status');
            }

            const status = await statusResponse.json();
            
            if (status.status === 'completed') {
              await this.createVideoObject(videoId, status.thumbnailUrl);
              resolve();
            } else if (status.status === 'failed') {
              throw new Error('Video conversion failed');
            } else {
              // Update progress
              const progress = Math.max(60, Math.min(95, 60 + (status.progress || 0) * 0.35));
              this.progressFill.style.width = `${progress}%`;
              this.progressText.textContent = `Converting video... ${Math.round(progress)}%`;
              
              attempts++;
              if (attempts < maxAttempts) {
                setTimeout(poll, 1000); // Poll every second
              } else {
                throw new Error('Conversion timeout');
              }
            }
          } catch (error) {
            reject(error);
          }
        };

        poll();
      });
    }

    private async createVideoObject(videoId: string, thumbnailUrl?: string) {
      // For client-side storage, we still need the data URL
      const videoUrl = await this.fileToDataURL(this.selectedFile);
      
      const tags = this.tagsInput.value
        .split(',')
        .map(tag => tag.trim())
        .filter(tag => tag.length > 0);

      // Create video object
      const newVideo = {
        id: videoId,
        uploaderHash: generateAnonymousHash(),
        title: this.titleInput.value.trim(),
        url: videoUrl,
        thumbnailUrl: thumbnailUrl,
        tags: tags,
        timestamp: Date.now(),
        comments: []
      };

      // Add to store
      addVideo(newVideo);
    }

    private showSuccess() {
      this.successMessage.style.display = 'block';
      setTimeout(() => {
        this.successMessage.style.display = 'none';
      }, 3000);
    }

    private resetForm() {
      this.titleInput.value = '';
      this.tagsInput.value = '';
      this.removeFile();
      this.uploading = false;
      this.uploadBtn.disabled = true;
      this.uploadBtn.textContent = 'Upload Video';
      this.uploadProgress.style.display = 'none';
    }

    private fileToDataURL(file: File): Promise<string> {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result as string);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    private formatFileSize(bytes: number): string {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
  }

  // Initialize upload form
  document.addEventListener('DOMContentLoaded', () => {
    const uploadForm = document.querySelector('.upload-form');
    if (uploadForm) {
      new UploadForm(uploadForm as HTMLElement);
    }
  });
</script>

<style>
  .upload-form {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .file-drop {
    border: 2px dashed #dddddd;
    border-radius: 8px;
    padding: 40px;
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
    background: #f8f8f8;
  }

  .file-drop:hover,
  .file-drop.drag-over {
    border-color: #1ab7ea;
    background: #f8fcff;
  }

  .drop-zone {
    display: block;
  }

  .drop-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
  }

  .drop-icon {
    font-size: 48px;
    opacity: 0.6;
  }

  .drop-content p {
    margin: 0;
    color: #666666;
    font-size: 16px;
  }

  .drop-content small {
    color: #999999;
    font-size: 14px;
  }

  .file-selected {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #e8f7ff;
    border: 1px solid #1ab7ea;
    padding: 15px;
    border-radius: 8px;
  }

  .file-info {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }

  .file-name {
    color: #1ab7ea;
    font-weight: 500;
    font-size: 14px;
  }

  .file-details {
    color: #666666;
    font-size: 12px;
  }

  .remove-btn {
    background: #dc2626;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    transition: background 0.2s ease;
  }

  .remove-btn:hover {
    background: #b91c1c;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .form-group label {
    color: #333333;
    font-weight: 500;
    font-size: 14px;
  }

  .form-group input {
    padding: 12px;
    border: 1px solid #dddddd;
    border-radius: 4px;
    font-size: 14px;
    background: white;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
  }

  .form-group input:focus {
    outline: none;
    border-color: #1ab7ea;
    box-shadow: 0 0 0 2px rgba(26, 183, 234, 0.2);
  }

  .form-group input::placeholder {
    color: #999999;
  }

  .upload-progress {
    background: #f8f8f8;
    border: 1px solid #dddddd;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
  }

  .progress-bar {
    width: 100%;
    height: 8px;
    background: #e5e5e5;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 15px;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #1ab7ea 0%, #158bb8 100%);
    border-radius: 4px;
    transition: width 0.3s ease;
    width: 0%;
  }

  #progress-text {
    color: #666666;
    font-size: 14px;
    margin: 0;
  }

  .success-message {
    background: #d1fae5;
    border: 1px solid #10b981;
    color: #047857;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    font-weight: 500;
  }

  .upload-btn {
    background: #1ab7ea;
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 500;
    font-size: 16px;
    transition: all 0.2s ease;
    font-family: inherit;
  }

  .upload-btn:hover:not(:disabled) {
    background: #158bb8;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(26, 183, 234, 0.3);
  }

  .upload-btn:disabled {
    background: #cccccc;
    color: #666666;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .file-drop {
      padding: 30px 20px;
    }

    .drop-icon {
      font-size: 36px;
    }

    .drop-content p {
      font-size: 14px;
    }

    .upload-btn {
      padding: 12px 24px;
      font-size: 14px;
    }
  }

  @media (max-width: 480px) {
    .file-drop {
      padding: 20px 15px;
    }

    .file-selected {
      flex-direction: column;
      gap: 15px;
      text-align: center;
    }

    .upload-progress {
      padding: 15px;
    }
  }
</style>