---
export interface Props {
  video: {
    id: string;
    uploaderHash: string;
    title: string;
    url: string;
    tags: string[];
    timestamp: number;
    comments: Array<any>;
  };
}

const { video } = Astro.props;

function formatDate(date: Date): string {
  const now = new Date();
  const diff = now.getTime() - date.getTime();
  const minutes = Math.floor(diff / 60000);
  const hours = Math.floor(diff / 3600000);
  const days = Math.floor(diff / 86400000);
  
  if (minutes < 1) return 'Just now';
  if (minutes < 60) return `${minutes}m ago`;
  if (hours < 24) return `${hours}h ago`;
  if (days < 7) return `${days}d ago`;
  return date.toLocaleDateString();
}
---

<div 
  class="video-card" 
  data-video-id={video.id}
  data-video-data={JSON.stringify(video)}
  role="button"
  tabindex="0"
  aria-label={`Play video: ${video.title}`}
>
  <div class="video-thumbnail">
    {video.url ? (
      <video 
        class="video-thumb"
        src={video.url}
        preload="metadata"
        muted
      />
    ) : (
      <div class="video-placeholder">
        <div class="placeholder-icon">ðŸ“¹</div>
      </div>
    )}
    
    <div class="play-overlay">
      <div class="play-icon"></div>
    </div>
  </div>
  
  <div class="video-info">
    <h3 class="video-title">{video.title || 'Untitled'}</h3>
    <div class="video-meta">
      <span class="video-author">Anonymous</span>
      <span class="video-date">{formatDate(new Date(video.timestamp))}</span>
    </div>
  </div>
</div>

<script>
  import { selectedVideo } from '../lib/stores.ts';

  class VideoCard {
    private element: HTMLElement;
    private videoData: any;

    constructor(element: HTMLElement) {
      this.element = element;
      this.videoData = JSON.parse(element.dataset.videoData || '{}');
      this.init();
    }

    private init() {
      this.setupEventListeners();
    }

    private setupEventListeners() {
      this.element.addEventListener('click', this.handleClick.bind(this));
      this.element.addEventListener('keypress', this.handleKeyPress.bind(this));
    }

    private handleClick() {
      selectedVideo.set(this.videoData);
    }

    private handleKeyPress(event: KeyboardEvent) {
      if (event.key === 'Enter' || event.key === ' ') {
        event.preventDefault();
        selectedVideo.set(this.videoData);
      }
    }
  }

  // Initialize all video cards
  document.addEventListener('DOMContentLoaded', () => {
    const videoCards = document.querySelectorAll('.video-card');
    videoCards.forEach(card => new VideoCard(card as HTMLElement));
  });

  // Also initialize any dynamically added cards
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      mutation.addedNodes.forEach((node) => {
        if (node.nodeType === Node.ELEMENT_NODE) {
          const element = node as Element;
          if (element.classList.contains('video-card')) {
            new VideoCard(element as HTMLElement);
          }
          
          const cards = element.querySelectorAll('.video-card');
          cards.forEach(card => new VideoCard(card as HTMLElement));
        }
      });
    });
  });

  observer.observe(document.body, { childList: true, subtree: true });
</script>

<style>
  .video-card {
    background: white;
    border-radius: 4px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
  }

  .video-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transform: translateY(-2px);
  }

  .video-card:focus {
    outline: 2px solid #1ab7ea;
    outline-offset: 2px;
  }

  .video-thumbnail {
    position: relative;
    width: 100%;
    height: 169px;
    background: #000000;
    overflow: hidden;
  }

  .video-thumb {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: opacity 0.3s ease;
  }

  .video-card:hover .video-thumb {
    opacity: 0.9;
  }

  .video-placeholder {
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #f1f3f4 0%, #e8eaed 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #999999;
    font-size: 24px;
  }

  .placeholder-icon {
    opacity: 0.7;
  }

  .play-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .video-card:hover .play-overlay {
    opacity: 1;
  }

  .play-icon {
    width: 60px;
    height: 60px;
    background: rgba(26, 183, 234, 0.9);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 20px;
    border: 3px solid rgba(255,255,255,0.8);
    position: relative;
  }

  .play-icon::before {
    content: 'â–¶';
    margin-left: 2px;
  }

  .video-info {
    padding: 15px;
  }

  .video-title {
    font-size: 16px;
    font-weight: 500;
    color: #333333;
    margin: 0 0 8px 0;
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .video-meta {
    display: flex;
    align-items: center;
    justify-content: space-between;
    color: #999999;
    font-size: 12px;
  }

  .video-author {
    color: #1ab7ea;
    text-decoration: none;
    font-weight: 500;
  }

  .video-author:hover {
    color: #158bb8;
  }

  .video-date {
    color: #999999;
  }
</style>