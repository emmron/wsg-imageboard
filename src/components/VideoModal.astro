---

---

<!-- Video Modal for clean Vimeo-style viewing -->
<div id="video-modal" class="video-modal" style="display: none;">
  <div class="modal-content">
    <button class="close-btn" id="close-modal" aria-label="Close video">Ã—</button>
    
    <video 
      id="modal-video" 
      class="modal-video" 
      controls
      autoplay
    >
      <track kind="captions" label="No captions available">
    </video>
    
    <div class="modal-info">
      <h3 class="modal-title" id="modal-title">Video Title</h3>
      <div class="modal-meta" id="modal-meta">
        <span class="modal-author">Anonymous</span>
        <span class="modal-date">Just now</span>
      </div>
    </div>
  </div>
</div>

<script>
  import { selectedVideo } from '../lib/stores.ts';

  class VideoModal {
    private modal: HTMLElement;
    private video: HTMLVideoElement;
    private closeBtn: HTMLButtonElement;
    private modalTitle: HTMLElement;
    private modalMeta: HTMLElement;
    private currentVideo: any = null;

    constructor() {
      this.initializeElements();
      this.setupEventListeners();
      this.subscribeToStore();
    }

    private initializeElements() {
      this.modal = document.getElementById('video-modal') as HTMLElement;
      this.video = document.getElementById('modal-video') as HTMLVideoElement;
      this.closeBtn = document.getElementById('close-modal') as HTMLButtonElement;
      this.modalTitle = document.getElementById('modal-title') as HTMLElement;
      this.modalMeta = document.getElementById('modal-meta') as HTMLElement;
    }

    private setupEventListeners() {
      // Modal events
      this.modal.addEventListener('click', this.handleModalClick.bind(this));
      this.closeBtn.addEventListener('click', this.closeModal.bind(this));

      // Keyboard events
      document.addEventListener('keydown', this.handleKeyPress.bind(this));
    }

    private subscribeToStore() {
      selectedVideo.subscribe((video) => {
        if (video) {
          this.showModal(video);
        } else {
          this.hideModal();
        }
      });
    }

    private showModal(video: any) {
      this.currentVideo = video;
      this.populateVideoData(video);
      this.modal.classList.add('active');
      document.body.style.overflow = 'hidden';

      // Set video source
      this.video.src = video.url;
    }

    private hideModal() {
      this.modal.classList.remove('active');
      document.body.style.overflow = '';
      this.video.src = '';
      this.currentVideo = null;
    }

    private populateVideoData(video: any) {
      this.modalTitle.textContent = video.title || 'Untitled';
      
      const authorSpan = this.modalMeta.querySelector('.modal-author') as HTMLElement;
      const dateSpan = this.modalMeta.querySelector('.modal-date') as HTMLElement;
      
      if (authorSpan) authorSpan.textContent = 'Anonymous';
      if (dateSpan) dateSpan.textContent = this.formatDate(new Date(video.timestamp));
    }

    private closeModal() {
      selectedVideo.set(null);
    }

    private handleModalClick(event: Event) {
      if (event.target === this.modal) {
        this.closeModal();
      }
    }

    private handleKeyPress(event: KeyboardEvent) {
      if (!this.currentVideo) return;

      switch (event.key) {
        case 'Escape':
          this.closeModal();
          break;
      }
    }

    private formatDate(date: Date): string {
      const now = new Date();
      const diff = now.getTime() - date.getTime();
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      
      if (minutes < 1) return 'Just now';
      if (minutes < 60) return `${minutes}m ago`;
      if (hours < 24) return `${hours}h ago`;
      if (days < 7) return `${days}d ago`;
      return date.toLocaleDateString();
    }
  }

  // Initialize video modal
  document.addEventListener('DOMContentLoaded', () => {
    new VideoModal();
  });
</script>

<style>
  .video-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.9);
    z-index: 2000;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .video-modal.active {
    display: flex;
  }

  .modal-content {
    background: white;
    border-radius: 4px;
    max-width: 90vw;
    max-height: 90vh;
    overflow: hidden;
    position: relative;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
  }

  .modal-video {
    width: 100%;
    height: auto;
    max-height: 70vh;
    display: block;
    background: black;
  }

  .modal-info {
    padding: 20px;
  }

  .modal-title {
    font-size: 20px;
    font-weight: 500;
    color: #333333;
    margin-bottom: 10px;
    line-height: 1.3;
  }

  .modal-meta {
    color: #666666;
    font-size: 14px;
    margin-bottom: 15px;
  }

  .modal-author {
    color: #1ab7ea;
    text-decoration: none;
    font-weight: 500;
  }

  .modal-author:hover {
    color: #158bb8;
  }

  .modal-date {
    color: #999999;
  }

  .close-btn {
    position: absolute;
    top: 15px;
    right: 20px;
    background: rgba(0,0,0,0.7);
    border: none;
    font-size: 24px;
    color: white;
    cursor: pointer;
    z-index: 10;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s ease;
  }

  .close-btn:hover {
    background: rgba(0,0,0,0.9);
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .modal-content {
      max-width: 95vw;
      max-height: 95vh;
    }

    .modal-info {
      padding: 15px;
    }
  }

  @media (max-width: 480px) {
    .modal-info {
      padding: 12px;
    }

    .modal-title {
      font-size: 18px;
    }
  }
</style>