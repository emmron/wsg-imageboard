---
import Layout from '../layouts/Layout.astro';
import Navigation from '../components/Navigation.astro';
---

<Layout title="Vimeo - Share your videos with the world">
  <Navigation />
  
  <main class="main">
    <!-- Hero Section -->
    <section class="hero">
      <div class="container">
        <h1>Share your videos with the world</h1>
        <p>Upload, host, and share videos that inspire, educate, and entertain. Create something amazing.</p>
        <button class="btn btn-large hero-upload-btn" id="hero-upload-btn">
          Upload your first video
        </button>
      </div>
    </section>

    <!-- Video Grid Section -->
    <section class="videos-section">
      <div class="container">
        <div class="section-header">
          <h2>Recent uploads</h2>
          <div class="section-controls">
            <button class="filter-btn active" data-filter="all">All</button>
            <button class="filter-btn" data-filter="recent">Recent</button>
            <button class="filter-btn" data-filter="popular">Popular</button>
          </div>
        </div>
        
        <!-- Video Grid -->
        <div class="videos-grid" id="videos-grid">
          <!-- Videos will be inserted here -->
        </div>

        <!-- Empty State -->
        <div class="empty-state" id="empty-state" style="display: none;">
          <h3>No videos yet</h3>
          <p>Be the first to share a video with the community</p>
          <button class="btn btn-large" id="empty-upload-btn">Upload first video</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Video Modal -->
  <div class="video-modal" id="video-modal">
    <div class="modal-content">
      <button class="close-btn" id="close-modal">Ã—</button>
      <video class="modal-video" id="modal-video" controls>
        <track kind="captions" label="No captions available">
      </video>
      <div class="modal-info">
        <h3 class="modal-title" id="modal-title">Video Title</h3>
        <div class="modal-meta" id="modal-meta">
          <span class="modal-author">Anonymous</span>
          <span class="modal-date">Just now</span>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  import { videos, showUploadModal } from '../lib/stores.ts';

  class VimeoVideoApp {
    private videosGrid: HTMLElement;
    private emptyState: HTMLElement;
    private videoModal: HTMLElement;
    private modalVideo: HTMLVideoElement;
    private modalTitle: HTMLElement;
    private modalMeta: HTMLElement;
    private closeModal: HTMLElement;
    private heroUploadBtn: HTMLElement;
    private emptyUploadBtn: HTMLElement;
    private filterBtns: NodeListOf<HTMLElement>;

    constructor() {
      this.videosGrid = document.getElementById('videos-grid') as HTMLElement;
      this.emptyState = document.getElementById('empty-state') as HTMLElement;
      this.videoModal = document.getElementById('video-modal') as HTMLElement;
      this.modalVideo = document.getElementById('modal-video') as HTMLVideoElement;
      this.modalTitle = document.getElementById('modal-title') as HTMLElement;
      this.modalMeta = document.getElementById('modal-meta') as HTMLElement;
      this.closeModal = document.getElementById('close-modal') as HTMLElement;
      this.heroUploadBtn = document.getElementById('hero-upload-btn') as HTMLElement;
      this.emptyUploadBtn = document.getElementById('empty-upload-btn') as HTMLElement;
      this.filterBtns = document.querySelectorAll('.filter-btn') as NodeListOf<HTMLElement>;

      this.setupEventListeners();
      this.loadVideos();
    }

    private setupEventListeners() {
      // Upload button listeners
      this.heroUploadBtn?.addEventListener('click', () => {
        showUploadModal.set(true);
      });

      this.emptyUploadBtn?.addEventListener('click', () => {
        showUploadModal.set(true);
      });

      // Modal listeners
      this.videoModal?.addEventListener('click', (e) => {
        if (e.target === this.videoModal) {
          this.closeVideoModal();
        }
      });

      this.closeModal?.addEventListener('click', () => {
        this.closeVideoModal();
      });

      // Filter listeners
      this.filterBtns?.forEach(btn => {
        btn.addEventListener('click', () => {
          this.filterBtns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          this.filterVideos(btn.dataset.filter || 'all');
        });
      });

      // Escape key to close modal
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && this.videoModal.classList.contains('active')) {
          this.closeVideoModal();
        }
      });

      // Subscribe to video store changes
      videos.subscribe((videoList) => {
        this.renderVideos(videoList);
      });
    }

    private loadVideos() {
      const videoList = videos.get();
      this.renderVideos(videoList);
    }

    private renderVideos(videoList: any[]) {
      if (videoList.length === 0) {
        this.emptyState.style.display = 'block';
        this.videosGrid.style.display = 'none';
        return;
      }

      this.emptyState.style.display = 'none';
      this.videosGrid.style.display = 'grid';
      this.videosGrid.innerHTML = '';

      videoList.forEach(video => {
        this.createVideoCard(video);
      });
    }

    private createVideoCard(video: any) {
      const card = document.createElement('div');
      card.className = 'video-card';
      card.innerHTML = `
        <div class="video-thumbnail">
          ${video.url ? `
            <video class="video-thumb" src="${video.url}" preload="metadata" muted></video>
            <div class="play-overlay">
              <div class="play-icon"></div>
            </div>
          ` : `
            <div class="video-placeholder">
              <div class="play-icon"></div>
            </div>
          `}
        </div>
        <div class="video-info">
          <h3 class="video-title">${this.escapeHtml(video.title || 'Untitled')}</h3>
          <div class="video-meta">
            <span class="video-author">Anonymous</span>
            <span class="video-date">${this.formatDate(new Date(video.timestamp))}</span>
          </div>
        </div>
      `;

      card.addEventListener('click', () => {
        this.openVideoModal(video);
      });

      this.videosGrid.appendChild(card);
    }

    private openVideoModal(video: any) {
      if (!video.url) return;

      this.modalVideo.src = video.url;
      this.modalTitle.textContent = video.title || 'Untitled';
      
      const authorSpan = this.modalMeta.querySelector('.modal-author') as HTMLElement;
      const dateSpan = this.modalMeta.querySelector('.modal-date') as HTMLElement;
      
      if (authorSpan) authorSpan.textContent = 'Anonymous';
      if (dateSpan) dateSpan.textContent = this.formatDate(new Date(video.timestamp));

      this.videoModal.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    private closeVideoModal() {
      this.videoModal.classList.remove('active');
      this.modalVideo.src = '';
      document.body.style.overflow = '';
    }

    private filterVideos(filter: string) {
      const videoList = videos.get();
      let filteredVideos = [...videoList];

      switch (filter) {
        case 'recent':
          filteredVideos.sort((a, b) => b.timestamp - a.timestamp);
          break;
        case 'popular':
          // Sort by number of comments (as a simple popularity metric)
          filteredVideos.sort((a, b) => (b.comments?.length || 0) - (a.comments?.length || 0));
          break;
        default:
          // 'all' - keep original order
          break;
      }

      this.renderVideos(filteredVideos);
    }

    private formatDate(date: Date): string {
      const now = new Date();
      const diff = now.getTime() - date.getTime();
      const seconds = Math.floor(diff / 1000);
      const minutes = Math.floor(seconds / 60);
      const hours = Math.floor(minutes / 60);
      const days = Math.floor(hours / 24);

      if (days > 0) {
        return days === 1 ? '1 day ago' : `${days} days ago`;
      } else if (hours > 0) {
        return hours === 1 ? '1 hour ago' : `${hours} hours ago`;
      } else if (minutes > 0) {
        return minutes === 1 ? '1 minute ago' : `${minutes} minutes ago`;
      } else {
        return 'Just now';
      }
    }

    private escapeHtml(text: string): string {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  }

  // Initialize the app
  document.addEventListener('DOMContentLoaded', () => {
    new VimeoVideoApp();
  });
</script>

<style>
  .main {
    margin-top: 60px;
    min-height: calc(100vh - 60px);
  }

  .hero {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    padding: 80px 0;
    text-align: center;
    border-bottom: 1px solid #e9ecef;
  }

  .hero h1 {
    font-size: 48px;
    font-weight: 300;
    color: #333333;
    margin-bottom: 20px;
    letter-spacing: -2px;
    line-height: 1.2;
  }

  .hero p {
    font-size: 18px;
    color: #666666;
    margin-bottom: 40px;
    font-weight: 300;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
  }

  .hero-upload-btn {
    font-size: 16px;
    padding: 16px 32px;
    border-radius: 4px;
    box-shadow: 0 2px 8px rgba(26, 183, 234, 0.3);
    transition: all 0.3s ease;
  }

  .hero-upload-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(26, 183, 234, 0.4);
  }

  .videos-section {
    padding: 60px 0;
  }

  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 40px;
  }

  .section-header h2 {
    font-size: 28px;
    font-weight: 300;
    color: #333333;
    letter-spacing: -1px;
  }

  .section-controls {
    display: flex;
    gap: 10px;
  }

  .filter-btn {
    background: transparent;
    border: 1px solid #dddddd;
    color: #666666;
    padding: 8px 16px;
    border-radius: 3px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: inherit;
  }

  .filter-btn:hover {
    border-color: #1ab7ea;
    color: #1ab7ea;
  }

  .filter-btn.active {
    background: #1ab7ea;
    border-color: #1ab7ea;
    color: white;
  }

  .video-placeholder {
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #f1f3f4 0%, #e8eaed 100%);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .video-placeholder .play-icon {
    opacity: 0.7;
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .hero {
      padding: 60px 0;
    }

    .hero h1 {
      font-size: 36px;
    }

    .hero p {
      font-size: 16px;
      margin-bottom: 30px;
    }

    .section-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 20px;
    }

    .section-header h2 {
      font-size: 24px;
    }

    .section-controls {
      align-self: stretch;
    }

    .filter-btn {
      flex: 1;
      text-align: center;
    }

    .videos-section {
      padding: 40px 0;
    }
  }

  @media (max-width: 480px) {
    .hero {
      padding: 40px 0;
    }

    .hero h1 {
      font-size: 28px;
    }

    .hero p {
      font-size: 15px;
    }

    .section-header h2 {
      font-size: 22px;
    }

    .filter-btn {
      font-size: 13px;
      padding: 6px 12px;
    }
  }
</style>