---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Settings - FanConnect">
  <main class="settings-container">
    <div class="settings-sidebar">
      <h2>Settings</h2>
      <nav class="settings-nav">
        <button class="nav-item active" data-tab="profile">Profile</button>
        <button class="nav-item" data-tab="account">Account</button>
        <button class="nav-item" data-tab="creator">Creator Settings</button>
        <button class="nav-item" data-tab="privacy">Privacy</button>
      </nav>
    </div>

    <div class="settings-content">
      <!-- Profile Tab -->
      <div class="tab-content active" id="profile-tab">
        <h1>Profile Settings</h1>
        <p class="tab-description">Manage your public profile information</p>

        <form id="profileForm" class="settings-form">
          <div class="form-section">
            <h3>Profile Picture</h3>
            <div class="avatar-upload">
              <div class="avatar-preview" id="avatarPreview">
                <div class="avatar-placeholder"></div>
              </div>
              <div class="upload-controls">
                <input type="file" id="avatarInput" accept="image/*" hidden />
                <button type="button" class="btn-secondary" id="uploadAvatarBtn">
                  Upload Photo
                </button>
                <p class="help-text">JPG, PNG or GIF. Max size 5MB</p>
              </div>
            </div>
          </div>

          <div class="form-section">
            <h3>Cover Photo</h3>
            <div class="cover-upload">
              <div class="cover-preview" id="coverPreview">
                <div class="cover-placeholder"></div>
              </div>
              <div class="upload-controls">
                <input type="file" id="coverInput" accept="image/*" hidden />
                <button type="button" class="btn-secondary" id="uploadCoverBtn">
                  Upload Cover
                </button>
                <p class="help-text">JPG or PNG. Recommended 1500x500px</p>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="displayName">Display Name</label>
            <input
              type="text"
              id="displayName"
              name="displayName"
              placeholder="Your display name"
            />
          </div>

          <div class="form-group">
            <label for="username">Username</label>
            <input
              type="text"
              id="username"
              name="username"
              placeholder="@username"
              pattern="[a-zA-Z0-9_]+"
              disabled
            />
            <p class="help-text">Username cannot be changed</p>
          </div>

          <div class="form-group">
            <label for="bio">Bio</label>
            <textarea
              id="bio"
              name="bio"
              rows="4"
              placeholder="Tell people about yourself"
              maxlength="500"
            ></textarea>
            <p class="char-count"><span id="bioCount">0</span>/500</p>
          </div>

          <div id="profileError" class="error-message"></div>
          <div id="profileSuccess" class="success-message"></div>

          <button type="submit" class="btn-primary" id="saveProfileBtn">
            Save Changes
          </button>
        </form>
      </div>

      <!-- Account Tab -->
      <div class="tab-content" id="account-tab">
        <h1>Account Settings</h1>
        <p class="tab-description">Manage your account and security</p>

        <form id="accountForm" class="settings-form">
          <div class="form-group">
            <label for="email">Email Address</label>
            <input
              type="email"
              id="email"
              name="email"
              placeholder="your@email.com"
              disabled
            />
            <p class="help-text">Contact support to change email</p>
          </div>

          <div class="form-section">
            <h3>Change Password</h3>
            <div class="form-group">
              <label for="currentPassword">Current Password</label>
              <input
                type="password"
                id="currentPassword"
                name="currentPassword"
                placeholder="Enter current password"
              />
            </div>

            <div class="form-group">
              <label for="newPassword">New Password</label>
              <input
                type="password"
                id="newPassword"
                name="newPassword"
                placeholder="Enter new password"
                minlength="6"
              />
            </div>

            <div class="form-group">
              <label for="confirmPassword">Confirm New Password</label>
              <input
                type="password"
                id="confirmPassword"
                name="confirmPassword"
                placeholder="Confirm new password"
                minlength="6"
              />
            </div>

            <button type="button" class="btn-secondary" id="changePasswordBtn">
              Update Password
            </button>
          </div>
        </form>
      </div>

      <!-- Creator Tab -->
      <div class="tab-content" id="creator-tab">
        <h1>Creator Settings</h1>
        <p class="tab-description">Manage your creator account and monetization</p>

        <form id="creatorForm" class="settings-form">
          <div class="form-group checkbox-group">
            <label>
              <input type="checkbox" id="isCreator" name="isCreator" />
              <span>Enable creator mode</span>
            </label>
            <p class="help-text">Allow others to subscribe to your content</p>
          </div>

          <div class="form-group">
            <label for="subscriptionPrice">Monthly Subscription Price (USD)</label>
            <input
              type="number"
              id="subscriptionPrice"
              name="subscriptionPrice"
              min="0"
              step="0.01"
              placeholder="0.00"
            />
            <p class="help-text">Set to 0 for free content</p>
          </div>

          <div id="creatorError" class="error-message"></div>
          <div id="creatorSuccess" class="success-message"></div>

          <button type="submit" class="btn-primary" id="saveCreatorBtn">
            Save Creator Settings
          </button>
        </form>
      </div>

      <!-- Privacy Tab -->
      <div class="tab-content" id="privacy-tab">
        <h1>Privacy Settings</h1>
        <p class="tab-description">Control your privacy and visibility</p>

        <div class="settings-form">
          <div class="form-group checkbox-group">
            <label>
              <input type="checkbox" id="showEmail" />
              <span>Show email on profile</span>
            </label>
          </div>

          <div class="form-group checkbox-group">
            <label>
              <input type="checkbox" id="allowMessages" checked />
              <span>Allow direct messages</span>
            </label>
          </div>

          <div class="form-section danger-zone">
            <h3>Danger Zone</h3>
            <button type="button" class="btn-danger" id="deleteAccountBtn">
              Delete Account
            </button>
            <p class="help-text">This action cannot be undone</p>
          </div>
        </div>
      </div>
    </div>
  </main>
</Layout>

<script>
  import { supabase } from '../lib/supabase';
  import { currentUser, currentProfile, updateProfile } from '../lib/auth-store';
  import { put } from '@vercel/blob';

  let profile: any = null;
  let user: any = null;

  // Get current user and profile
  currentUser.subscribe(u => user = u);
  currentProfile.subscribe(p => profile = p);

  if (!user) {
    window.location.href = '/login';
  }

  // Load profile data
  if (profile) {
    const displayNameInput = document.getElementById('displayName') as HTMLInputElement;
    const usernameInput = document.getElementById('username') as HTMLInputElement;
    const bioInput = document.getElementById('bio') as HTMLTextAreaElement;
    const emailInput = document.getElementById('email') as HTMLInputElement;
    const isCreatorInput = document.getElementById('isCreator') as HTMLInputElement;
    const subscriptionPriceInput = document.getElementById('subscriptionPrice') as HTMLInputElement;

    displayNameInput.value = profile.display_name || '';
    usernameInput.value = profile.username || '';
    bioInput.value = profile.bio || '';
    emailInput.value = user.email || '';
    isCreatorInput.checked = profile.is_creator || false;
    subscriptionPriceInput.value = profile.subscription_price?.toString() || '0';

    // Update avatar preview
    if (profile.avatar_url) {
      const avatarPreview = document.getElementById('avatarPreview')!;
      avatarPreview.innerHTML = `<img src="${profile.avatar_url}" alt="Avatar" />`;
    }

    // Update cover preview
    if (profile.cover_url) {
      const coverPreview = document.getElementById('coverPreview')!;
      coverPreview.innerHTML = `<img src="${profile.cover_url}" alt="Cover" />`;
    }
  }

  // Bio character count
  const bioInput = document.getElementById('bio') as HTMLTextAreaElement;
  const bioCount = document.getElementById('bioCount')!;
  bioInput?.addEventListener('input', () => {
    bioCount.textContent = bioInput.value.length.toString();
  });
  bioCount.textContent = bioInput?.value.length.toString() || '0';

  // Tab switching
  const navItems = document.querySelectorAll('.nav-item');
  const tabContents = document.querySelectorAll('.tab-content');

  navItems.forEach(item => {
    item.addEventListener('click', () => {
      const tabName = item.getAttribute('data-tab');

      navItems.forEach(i => i.classList.remove('active'));
      item.classList.add('active');

      tabContents.forEach(content => content.classList.remove('active'));
      document.getElementById(`${tabName}-tab`)?.classList.add('active');
    });
  });

  // Avatar upload
  const avatarInput = document.getElementById('avatarInput') as HTMLInputElement;
  const uploadAvatarBtn = document.getElementById('uploadAvatarBtn')!;

  uploadAvatarBtn?.addEventListener('click', () => {
    avatarInput.click();
  });

  avatarInput?.addEventListener('change', async () => {
    const file = avatarInput.files?.[0];
    if (!file) return;

    // Preview
    const reader = new FileReader();
    reader.onload = (e) => {
      const avatarPreview = document.getElementById('avatarPreview')!;
      avatarPreview.innerHTML = `<img src="${e.target?.result}" alt="Avatar" />`;
    };
    reader.readAsDataURL(file);

    // Upload to Vercel Blob
    try {
      const blob = await put(`avatars/${user.id}/${file.name}`, file, {
        access: 'public',
      });

      // Update profile
      await updateProfile({ avatar_url: blob.url });
    } catch (error) {
      console.error('Avatar upload error:', error);
      alert('Failed to upload avatar');
    }
  });

  // Cover upload
  const coverInput = document.getElementById('coverInput') as HTMLInputElement;
  const uploadCoverBtn = document.getElementById('uploadCoverBtn')!;

  uploadCoverBtn?.addEventListener('click', () => {
    coverInput.click();
  });

  coverInput?.addEventListener('change', async () => {
    const file = coverInput.files?.[0];
    if (!file) return;

    // Preview
    const reader = new FileReader();
    reader.onload = (e) => {
      const coverPreview = document.getElementById('coverPreview')!;
      coverPreview.innerHTML = `<img src="${e.target?.result}" alt="Cover" />`;
    };
    reader.readAsDataURL(file);

    // Upload to Vercel Blob
    try {
      const blob = await put(`covers/${user.id}/${file.name}`, file, {
        access: 'public',
      });

      // Update profile
      await updateProfile({ cover_url: blob.url });
    } catch (error) {
      console.error('Cover upload error:', error);
      alert('Failed to upload cover');
    }
  });

  // Profile form submit
  const profileForm = document.getElementById('profileForm') as HTMLFormElement;
  const profileError = document.getElementById('profileError')!;
  const profileSuccess = document.getElementById('profileSuccess')!;
  const saveProfileBtn = document.getElementById('saveProfileBtn') as HTMLButtonElement;

  profileForm?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(profileForm);
    const displayName = formData.get('displayName') as string;
    const bio = formData.get('bio') as string;

    profileError.textContent = '';
    profileSuccess.textContent = '';
    saveProfileBtn.disabled = true;
    saveProfileBtn.textContent = 'Saving...';

    try {
      await updateProfile({
        display_name: displayName,
        bio: bio,
      });

      profileSuccess.textContent = 'Profile updated successfully!';
      saveProfileBtn.disabled = false;
      saveProfileBtn.textContent = 'Save Changes';
    } catch (error: any) {
      profileError.textContent = error.message || 'Failed to update profile';
      saveProfileBtn.disabled = false;
      saveProfileBtn.textContent = 'Save Changes';
    }
  });

  // Creator form submit
  const creatorForm = document.getElementById('creatorForm') as HTMLFormElement;
  const creatorError = document.getElementById('creatorError')!;
  const creatorSuccess = document.getElementById('creatorSuccess')!;
  const saveCreatorBtn = document.getElementById('saveCreatorBtn') as HTMLButtonElement;

  creatorForm?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(creatorForm);
    const isCreator = (document.getElementById('isCreator') as HTMLInputElement).checked;
    const subscriptionPrice = parseFloat(formData.get('subscriptionPrice') as string) || 0;

    creatorError.textContent = '';
    creatorSuccess.textContent = '';
    saveCreatorBtn.disabled = true;
    saveCreatorBtn.textContent = 'Saving...';

    try {
      await updateProfile({
        is_creator: isCreator,
        subscription_price: subscriptionPrice,
      });

      creatorSuccess.textContent = 'Creator settings updated successfully!';
      saveCreatorBtn.disabled = false;
      saveCreatorBtn.textContent = 'Save Creator Settings';
    } catch (error: any) {
      creatorError.textContent = error.message || 'Failed to update creator settings';
      saveCreatorBtn.disabled = false;
      saveCreatorBtn.textContent = 'Save Creator Settings';
    }
  });
</script>

<style>
  .settings-container {
    display: flex;
    min-height: calc(100vh - 60px);
    margin-top: 60px;
    background: #f8f9fa;
  }

  .settings-sidebar {
    width: 280px;
    background: white;
    padding: 2rem;
    border-right: 1px solid #e0e0e0;
    position: sticky;
    top: 60px;
    height: calc(100vh - 60px);
    overflow-y: auto;
  }

  .settings-sidebar h2 {
    margin: 0 0 2rem 0;
    font-size: 1.5rem;
  }

  .settings-nav {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .nav-item {
    padding: 0.75rem 1rem;
    background: none;
    border: none;
    text-align: left;
    font-size: 1rem;
    color: #666;
    cursor: pointer;
    border-radius: 0.5rem;
    transition: all 0.2s;
  }

  .nav-item:hover {
    background: #f0f0f0;
    color: #333;
  }

  .nav-item.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  .settings-content {
    flex: 1;
    padding: 3rem;
    max-width: 800px;
  }

  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }

  .tab-content h1 {
    margin: 0 0 0.5rem 0;
    font-size: 2rem;
  }

  .tab-description {
    color: #666;
    margin: 0 0 2rem 0;
  }

  .settings-form {
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  .form-section {
    padding: 1.5rem;
    background: white;
    border-radius: 0.75rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .form-section h3 {
    margin: 0 0 1.5rem 0;
    font-size: 1.25rem;
  }

  .avatar-upload,
  .cover-upload {
    display: flex;
    gap: 2rem;
    align-items: center;
  }

  .avatar-preview {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    overflow: hidden;
    background: #f0f0f0;
  }

  .avatar-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .avatar-placeholder {
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }

  .cover-preview {
    width: 100%;
    height: 150px;
    border-radius: 0.5rem;
    overflow: hidden;
    background: #f0f0f0;
  }

  .cover-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .cover-placeholder {
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }

  .upload-controls {
    flex: 1;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .form-group label {
    font-weight: 600;
    color: #333;
  }

  .form-group input,
  .form-group textarea {
    padding: 0.75rem 1rem;
    border: 2px solid #e0e0e0;
    border-radius: 0.5rem;
    font-size: 1rem;
    transition: border-color 0.2s;
    font-family: inherit;
  }

  .form-group input:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: #667eea;
  }

  .form-group input:disabled {
    background: #f0f0f0;
    cursor: not-allowed;
  }

  .checkbox-group label {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-weight: normal;
    cursor: pointer;
  }

  .checkbox-group input[type="checkbox"] {
    width: 1.25rem;
    height: 1.25rem;
    cursor: pointer;
  }

  .help-text {
    font-size: 0.875rem;
    color: #999;
    margin: 0;
  }

  .char-count {
    font-size: 0.875rem;
    color: #999;
    text-align: right;
    margin: 0;
  }

  .btn-primary,
  .btn-secondary,
  .btn-danger {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 0.5rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 1rem;
  }

  .btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  .btn-primary:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
  }

  .btn-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .btn-secondary {
    background: #f0f0f0;
    color: #333;
  }

  .btn-secondary:hover {
    background: #e0e0e0;
  }

  .btn-danger {
    background: #e53e3e;
    color: white;
  }

  .btn-danger:hover {
    background: #c53030;
  }

  .error-message,
  .success-message {
    font-size: 0.9rem;
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
    margin: 0;
  }

  .error-message {
    background: #fee;
    color: #c53030;
  }

  .success-message {
    background: #efe;
    color: #38a169;
  }

  .danger-zone {
    border: 2px solid #e53e3e;
  }

  @media (max-width: 768px) {
    .settings-container {
      flex-direction: column;
    }

    .settings-sidebar {
      width: 100%;
      height: auto;
      position: static;
    }

    .settings-content {
      padding: 2rem 1rem;
    }

    .avatar-upload,
    .cover-upload {
      flex-direction: column;
    }
  }
</style>
